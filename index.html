<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon V48 - Final UI & Masking</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; text-align: center; padding: 10px; }
        .box { max-width: 850px; margin: 0 auto; background: #111; padding: 20px; border-radius: 15px; border: 1px solid #333; }
        
        .canvas-container { 
            margin: 15px 0; background: #222; line-height: 0; border: 1px solid #444; position: relative;
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #2a2a2a 75%), linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
        }
        canvas { max-width: 100%; height: auto; display: block; margin: 0 auto; }

        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; text-align: left; }
        .item { background: #222; padding: 12px; border-radius: 8px; border: 1px solid #444; }
        label { font-size: 13px; color: #00fbff; display: flex; justify-content: space-between; font-weight: bold; }
        input[type="range"] { width: 100%; margin-top: 8px; cursor: pointer; }
        .btn { 
            width: 100%; padding: 18px; background: #00fbff; color: #000; border: none; 
            font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 15px; font-size: 18px;
        }
        #msg { color: #ffd700; font-size: 14px; margin-top: 12px; }
    </style>
</head>
<body>

<div class="box">
    <h3 style="margin-top:0;">üöÄ V48 (‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á)</h3>
    <input type="file" id="fIn" accept="image/*">

    <div class="controls" style="margin-top:15px;">
        <div class="item">
            <label>‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ <input type="color" id="vBgCol" value="#000000"></label>
            <label style="margin-top:10px;">‡∏™‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô <input type="color" id="vCol" value="#ffffff"></label>
        </div>
        <div class="item"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠: <span id="sDur">5</span> ‡∏ß‡∏¥</label><input type="range" id="vDur" min="1" max="20" value="5"></div>
        <div class="item"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡πâ‡∏≤‡πÅ‡∏™‡∏á: <span id="sSpec">80</span>%</label><input type="range" id="vSpec" min="0" max="100" value="80"></div>
        <div class="item"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÅ‡∏™‡∏á: <span id="sSharp">20</span></label><input type="range" id="vSharp" min="1" max="100" value="20"></div>
        <div class="item"><label>‡∏≠‡∏á‡∏®‡∏≤‡πÅ‡∏™‡∏á: <span id="sTilt">45</span>¬∞</label><input type="range" id="vTilt" min="0" max="360" value="45"></div>
        <div class="item">
            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏™‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏° -> ‡∏à‡∏ö)</label>
            <div style="display:flex; gap:10px;">
                <input type="range" id="vStart" min="-1200" max="1200" value="-600">
                <input type="range" id="vEnd" min="-1200" max="1200" value="600">
            </div>
            <div style="font-size:10px; color:#888; margin-top:5px; display:flex; justify-content:space-between;">
                <span>‡πÄ‡∏£‡∏¥‡πà‡∏°: <span id="sStart">-600</span></span>
                <span>‡∏à‡∏ö: <span id="sEnd">600</span></span>
            </div>
        </div>
    </div>

    <div class="canvas-container"><canvas id="c"></canvas></div>

    <button id="bRec" class="btn" onclick="record()">üé• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
    <p id="msg">‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
</div>

<script>
    const cvs = document.getElementById('c');
    const ctx = cvs.getContext('2d');
    
    // ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Masking
    const imgLayer = document.createElement('canvas');
    const lightLayer = document.createElement('canvas');
    
    let img = null, isRec = false;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
    const ids = ['vCol','vSpec','vSharp','vDur','vTilt','vStart','vEnd','vBgCol'];
    ids.forEach(id => {
        document.getElementById(id).oninput = (e) => {
            const val = e.target.value;
            if(id === 'vDur') document.getElementById('sDur').innerText = val;
            if(id === 'vSpec') document.getElementById('sSpec').innerText = val;
            if(id === 'vSharp') document.getElementById('sSharp').innerText = val;
            if(id === 'vTilt') document.getElementById('sTilt').innerText = val;
            if(id === 'vStart') document.getElementById('sStart').innerText = val;
            if(id === 'vEnd') document.getElementById('sEnd').innerText = val;
            
            if(img && !isRec) {
                // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏£‡∏±‡∏ö vEnd ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ï‡∏≠‡∏ô‡∏à‡∏ö (p=1) ‡∏ô‡∏≠‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏î‡∏π‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (p=0)
                draw(id === 'vEnd' ? 1 : 0);
            }
        };
    });

    document.getElementById('fIn').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            img = new Image();
            img.onload = () => {
                const s = Math.min(1, 800/Math.max(img.width, img.height));
                const w = img.width * s, h = img.height * s;
                cvs.width = imgLayer.width = lightLayer.width = w;
                cvs.height = imgLayer.height = lightLayer.height = h;
                draw(0);
                document.getElementById('msg').innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!";
            };
            img.src = ev.target.result;
        };
        r.readAsDataURL(e.target.files[0]);
    };

    function draw(p) {
        if(!img) return;
        const w = cvs.width, h = cvs.height;

        // 1. ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏•‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏£‡∏π‡∏õ
        const iCtx = imgLayer.getContext('2d');
        iCtx.clearRect(0, 0, w, h);
        iCtx.drawImage(img, 0, 0, w, h);

        // 2. ‡∏ß‡∏≤‡∏î‡πÅ‡∏™‡∏á‡∏•‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÅ‡∏™‡∏á
        const lCtx = lightLayer.getContext('2d');
        lCtx.clearRect(0, 0, w, h);
        
        const tilt = parseInt(document.getElementById('vTilt').value);
        const start = parseInt(document.getElementById('vStart').value);
        const end = parseInt(document.getElementById('vEnd').value);
        const cur = start + (end - start) * p;
        const rad = (tilt - 90) * Math.PI / 180;
        const beam = parseInt(document.getElementById('vSharp').value) * 5;
        
        const x0 = w/2 + Math.cos(rad)*(cur-beam), y0 = h/2 + Math.sin(rad)*(cur-beam);
        const x1 = w/2 + Math.cos(rad)*(cur+beam), y1 = h/2 + Math.sin(rad)*(cur+beam);
        
        const g = lCtx.createLinearGradient(x0, y0, x1, y1);
        const hex = document.getElementById('vCol').value;
        const op = document.getElementById('vSpec').value / 100;
        const r = parseInt(hex.slice(1,3),16), g1 = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
        
        g.addColorStop(0,'transparent'); 
        g.addColorStop(0.5,`rgba(${r},${g1},${b},${op})`); 
        g.addColorStop(1,'transparent');
        
        lCtx.fillStyle = g;
        lCtx.fillRect(0, 0, w, h);

        // --- ‡∏ï‡∏±‡∏î‡πÅ‡∏™‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ ---
        lCtx.globalCompositeOperation = 'destination-in';
        lCtx.drawImage(imgLayer, 0, 0);
        lCtx.globalCompositeOperation = 'source-over';

        // 3. ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
        ctx.clearRect(0, 0, w, h);
        
        // ‡∏ñ‡∏°‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        ctx.fillStyle = document.getElementById('vBgCol').value;
        ctx.fillRect(0, 0, w, h);
        
        ctx.drawImage(imgLayer, 0, 0); // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ
        ctx.globalCompositeOperation = 'lighter'; // ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
        ctx.drawImage(lightLayer, 0, 0); // ‡∏ß‡∏≤‡∏î‡πÅ‡∏™‡∏á
        ctx.globalCompositeOperation = 'source-over';
    }

    function record() {
        if(!img || isRec) return;
        isRec = true;
        const btn = document.getElementById('bRec');
        const msg = document.getElementById('msg');
        btn.disabled = true; msg.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠...";

        const types = ['video/mp4;codecs=h264', 'video/webm;codecs=vp9', 'video/webm'];
        let selectedType = types.find(t => MediaRecorder.isTypeSupported(t));
        
        const chunks = [];
        const stream = cvs.captureStream(30);
        const rec = new MediaRecorder(stream, { mimeType: selectedType, videoBitsPerSecond: 8000000 });

        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `neon_video.mp4`; a.click();
            btn.disabled = false; isRec = false; msg.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
            draw(0);
        };

        const duration = parseInt(document.getElementById('vDur').value) * 1000;
        rec.start();
        const startT = performance.now();
        function frame(now) {
            const elapsed = now - startT;
            const p = Math.min(elapsed / duration, 1);
            draw(p);
            if (elapsed < duration) requestAnimationFrame(frame);
            else setTimeout(() => rec.stop(), 500);
        }
        requestAnimationFrame(frame);
    }
</script>

</body>
</html>
